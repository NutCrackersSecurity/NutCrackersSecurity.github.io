<p>Hello hackers! Today, we will demonstrate how to perform an Nmap firewall scan using Iptable rules and attempt to bypass the firewall filter to perform advanced NMAP scanning. Let’s get started!</p>

<p>For this demonstration, I will be using Virtualbox to simulate the scan.</p>

<ul>
  <li>Attacker’s IP: 192.168.0.22 [Kali Linux]</li>
  <li>Target’s IP: 192.168.0.19 [Ubuntu]</li>
</ul>

<h2 id="tcp-scan-analysis">TCP SCAN ANALYSIS:</h2>

<p>To perform a TCP (-sT-) scan for open port enumeration, open the terminal in your Kali Linux and execute the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">-sT</span> <span class="nt">-p</span> 80 192.168.0.19
</pre></td></tr></tbody></table></code></pre></div></div>
<p>From the image below, you can observe that we have scanned port 80, and the result shows that Port 80 is open.
<img src="/assets/img/headers/nmap/1.png" alt="scan" /></p>

<table>
  <thead>
    <tr>
      <th>Scan Name</th>
      <th>Flag</th>
      <th>Data Length</th>
      <th>TTL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-sT (TCP)</td>
      <td>SYN →</td>
      <td>60</td>
      <td>64</td>
    </tr>
    <tr>
      <td>-sS (Stealth)</td>
      <td>SYN →</td>
      <td>44</td>
      <td>&lt;64 (Less than 64)</td>
    </tr>
    <tr>
      <td>-sF (Finish)</td>
      <td>FIN →</td>
      <td>40</td>
      <td>&lt;64 (Less than 64)</td>
    </tr>
    <tr>
      <td>-sN (Null)</td>
      <td>NULL →</td>
      <td>40</td>
      <td>&lt;64 (Less than 64)</td>
    </tr>
    <tr>
      <td>-sX (Xmas)</td>
      <td>FIN, PSH, URG →</td>
      <td>40</td>
      <td>&lt;64 (Less than 64)</td>
    </tr>
  </tbody>
</table>

<h2 id="reject-syn-flag-with-iptables">Reject SYN Flag with IPTables</h2>

<p>To enhance network security, administrators often employ firewall filters to hinder attackers from performing TCP scans and disrupt the three-way handshake communication. One effective method is to reject SYN packets using IPTables.</p>

<p>To block SYN packets in Ubuntu and prevent TCP scans, execute the following command:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--tcp-flags</span> ALL SYN <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
</pre></td></tr></tbody></table></code></pre></div></div>
<p>IPTables functions as a firewall in Linux operating systems, and the specified rule will reject SYN packets, effectively thwarting TCP scans.</p>

<p>Once the firewall in the target network rejects SYN packets, the attacker becomes unable to enumerate open ports within the target network, even if the services are active. When the TCP scan is executed again, it indicates that Port 80 is closed.</p>

<p>By rejecting the SYN packets at the firewall level, the network’s security is strengthened, preventing unauthorized access and potential attacks. In this specific scenario, the result of the TCP scan reveals that Port 80 is not accessible or open for communication. This helps safeguard the network and its resources from potential vulnerabilities.
<img src="/assets/img/headers/nmap/4.png" alt="scan" /></p>

<h2 id="bypass-syn-filter">Bypass SYN Filter</h2>

<p>To bypass the SYN filter when the attacker fails to enumerate open ports using a TCP scan, advanced scanning methods can be employed. One such method is the FIN scan.</p>

<h3 id="fin-scan">FIN Scan</h3>

<p>In a FIN scan, the attacker utilizes a FIN packet to terminate the TCP connection between the source and destination ports. Unlike the SYN packet used in traditional TCP scans, Nmap initiates a FIN scan by sending a FIN packet.</p>

<p>To perform a FIN scan on Port 80 of the target IP address 192.168.0.19, you can use the following command:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">-sF</span> <span class="nt">-p</span> 80 192.168.0.19
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/img/headers/nmap/5.png" alt="scan" /></p>

<h3 id="null-scan-000000">NULL Scan (000000)</h3>
<p>To further bypass the firewall filter, another advanced scanning method is the NULL scan.</p>

<p>In a NULL scan, a series of TCP packets with a sequence number of “zeros” (0000000) are sent. Since no flags are set in these packets, the destination server does not know how to respond to the request. As a result, the packet is discarded, and no reply is sent back. If no response is received, it indicates that the port is open.</p>

<p>It’s important to note that NULL scans are typically effective on Linux machines and may not work on the latest versions of Windows.</p>

<p>To perform a NULL scan on Port 80 of the target IP address 192.168.0.19, you can use the following command:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">-sN</span> <span class="nt">-p</span> 80 192.168.0.19
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/img/headers/nmap/6.png" alt="scan" /></p>

<h3 id="xmas-scan">XMAS Scan</h3>

<p>After performing the XMAS scan, we can observe that Port 80 is indeed open. XD</p>

<p>The XMAS scan is a scanning technique that manipulates the PSH, URG, and FIN flags of the TCP header. By setting these flags simultaneously, the packet is illuminated like a Christmas tree. In this scan, the source sends a packet with the FIN, PUSH, and URG flags to a specific port. If the port is open, the destination server will discard the packets and not send any reply back to the source.</p>

<p>To perform an XMAS scan on Port 80 of the target IP address 192.168.0.19, you can use the following command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">-sX</span> <span class="nt">-p</span> 80 192.168.0.19
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="block-scan">Block Scan</h2>
<p>To block these types of scans, you can utilize iptables rules. Here’s how you can block each scan:</p>
<ul>
  <li>Blocking the FIN Scan:
    <ul>
      <li>To block the FIN scan, you can use the following iptables rule:
        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--tcp-flags</span> ALL FIN <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
</pre></td></tr></tbody></table></code></pre></div>        </div>
      </li>
      <li>This rule rejects any incoming TCP packets with the FIN flag set.</li>
    </ul>
  </li>
  <li>Blocking the NULL Scan:
    <ul>
      <li>To block the NULL scan, you can use the following iptables rule:
        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--tcp-flags</span> ALL NONE <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
</pre></td></tr></tbody></table></code></pre></div>        </div>
      </li>
      <li>This rule rejects any incoming TCP packets with no flags set.</li>
    </ul>
  </li>
  <li>Blocking the XMAS Scan:
    <ul>
      <li>To block the XMAS scan, you can use the following iptables rule:
        <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--tcp-flags</span> ALL FIN,PSH,URG <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
</pre></td></tr></tbody></table></code></pre></div>        </div>
      </li>
      <li>This rule rejects any incoming TCP packets with the FIN, PSH, and URG flags set.</li>
    </ul>
  </li>
</ul>

<p><img src="/assets/img/headers/nmap/8.png" alt="scan" />
<img src="/assets/img/headers/nmap/9.png" alt="scan" /></p>

<h2 id="reject-data-length-with-iptables">Reject Data-length with IPTABLES</h2>

<p>To further enhance network security and protect it from FIN, NULL, and XMAS scans, you can apply an additional iptables rule to reject incoming network traffic based on data length. This rule allows you to block TCP connections with a specific data length.</p>

<p>To apply a firewall rule that checks the data length and rejects TCP connections with a length of 60 (as confirmed from the table given above), you can use the following command:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">-m</span> length <span class="nt">--length</span> 60 <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
</pre></td></tr></tbody></table></code></pre></div></div>
<p>By implementing this rule, any TCP connections with a data length of 60 will be rejected, thereby preventing potential TCP scans from bypassing the network security measures.</p>

<p>After we scan we can see the port 80 is close.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">-sT</span> <span class="nt">-p</span> 80 192.168.0.19
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/img/headers/nmap/10.png" alt="scan" /></p>

<h2 id="bypass-data-length-with-stealth-scan">BYPASS DATA-LENGTH with STEALTH SCAN</h2>

<p>To bypass the firewall’s data length filter, attackers can utilize a scanning method known as the Stealth Scan.</p>

<p>When the attacker fails to enumerate open ports using a TCP scan, they can employ the Stealth Scan by using the following command:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">-sS</span> <span class="nt">-p</span> 80 192.168.0.19
</pre></td></tr></tbody></table></code></pre></div></div>
<p>In the Stealth Scan, the data length sent by default for TCP connections is 44. This scanning technique closely resembles a TCP scan and is also referred to as a “half-open” scan. It involves sending a SYN packet and receiving a SYN/ACK packet in response from the listening port. However, instead of sending an ACK packet back to the listening port, the Stealth Scan dumps the obtained result without completing the full three-way handshake.</p>

<p>By utilizing the Stealth Scan, attackers can attempt to bypass certain firewall filters that focus on data length, providing them with the opportunity to gather information about open ports and services on the target network.
<img src="/assets/img/headers/nmap/11.png" alt="scan" /></p>

<h2 id="fragment-scan">Fragment Scan</h2>
<p>The <code class="language-plaintext highlighter-rouge">-f</code> option in Nmap is used to perform a scan using tiny fragment IP packets. This technique involves splitting the TCP header over multiple packets, making it more challenging for packet filters, intrusion detection systems, and other security mechanisms to detect the scan. For instance, a 20-byte TCP header would be divided into three packets: two packets with eight bytes of the TCP header and one packet with the remaining four bytes.</p>

<p>To perform a scan using tiny fragment IP packets on Port 80 of the target IP address 192.168.0.19, you can use the following command:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">-f</span> <span class="nt">-p</span> 80 192.168.0.19
</pre></td></tr></tbody></table></code></pre></div></div>
<p>However, if the administrator applies firewall filters to reject data lengths of 40, 44, and 60, it will prevent attackers from executing the aforementioned scans, both basic and advanced. The following iptables rules can be applied to achieve this:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">-m</span> length <span class="nt">--length</span> 60 <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">-m</span> length <span class="nt">--length</span> 44 <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">-m</span> length <span class="nt">--length</span> 40 <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
</pre></td></tr></tbody></table></code></pre></div></div>
<p>By implementing these iptables rules, any TCP connections with data lengths of 60, 44, or 40 will be rejected, effectively blocking the corresponding scans.</p>

<p>Executing the various scans after applying the firewall rules will result in Port 80 being reported as closed:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">-sF</span> <span class="nt">-p</span> 80 192.168.0.19 <span class="o">(</span>port 80 is closed<span class="o">)</span>
nmap <span class="nt">-sX</span> <span class="nt">-p</span> 80 192.168.0.19 <span class="o">(</span>port 80 is closed<span class="o">)</span>
nmap <span class="nt">-sN</span> <span class="nt">-p</span> 80 192.168.0.19 <span class="o">(</span>port 80 is closed<span class="o">)</span>
nmap <span class="nt">-sS</span> <span class="nt">-p</span> 80 192.168.0.19 <span class="o">(</span>port 80 is closed<span class="o">)</span>
nmap <span class="nt">-sT</span> <span class="nt">-p</span> 80 192.168.0.19 <span class="o">(</span>port 80 is closed<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="data-length-scan">DATA LENGTH SCAN</h2>
<p>When attackers is unable to enumerate open port by applying above scan then he should go with nmap “data-lenght” which will bypass above firewall filtre too:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">--data-length</span> 12 <span class="nt">-p</span> 80 192.168.0.19 this is working
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/img/headers/nmap/15.png" alt="scan" /></p>

<p>But how can we stop this attack? So, we use REJECT LENGTH SIZE 1 to 100. If the administrator knows about the nmap data-length scan, he or she should block all data lengths to stop attackers from scanning the network by running the following Iptable rules:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>iptables <span class="nt">-I</span> INPUT <span class="nt">-p</span> tcp <span class="nt">-m</span> length <span class="nt">--length</span> 1:100 <span class="nt">-j</span> REJECT <span class="nt">--reject-with</span> tcp-reset
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now we can try again the scan</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>nmap <span class="nt">--data-length</span> 32 <span class="nt">-p</span> 80 192.168.0.19 <span class="nt">--</span><span class="o">&gt;</span> faild
nmap <span class="nt">--data-length</span> 12 <span class="nt">-p</span> 80 192.168.0.19 <span class="nt">--</span><span class="o">&gt;</span> faild
nmap <span class="nt">--data-length</span> 113 <span class="nt">-p</span> 80 192.168.0.19 <span class="nt">--</span><span class="o">&gt;</span> succed
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This is the final story, security is just a concept. All stuff can be break.</p>
